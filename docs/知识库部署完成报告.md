# âœ… çŸ¥è¯†åº“éƒ¨ç½²å®ŒæˆæŠ¥å‘Š

## ğŸ“Š éƒ¨ç½²ç»“æœ

### çŸ¥è¯†åº“æ•°æ®ä¸‹è½½æˆåŠŸ

| æ•°æ®æº | çŠ¶æ€ | å¤§å° | è®°å½•æ•° |
|--------|------|------|--------|
| **ClinVar** | âœ… å®Œæˆ | 178 MB | 92,817 æ¡ |
| **Gene Info** | âœ… å®Œæˆ | 5 MB | 193,834 æ¡ |
| **PharmGKB Genes** | âœ… å®Œæˆ | 2.8 MB | 25,041 æ¡ |
| **PharmGKB Variants** | âœ… å®Œæˆ | 73 KB | - |
| **gnomAD** | âš ï¸ éƒ¨åˆ† | 12 MB | - (æ–‡ä»¶æŸå) |

**æ€»è®¡ä¸‹è½½**: ~197 MB
**çŸ¥è¯†åº“æ•°æ®åº“**: 78.9 MB (SQLite)

### æ•°æ®åº“ç´¢å¼•æ„å»ºæˆåŠŸ

```
âœ… æ•°æ®åº“ä½ç½®: data/knowledge/knowledge.db
âœ… æ•°æ®åº“å¤§å°: 78.9 MB
âœ… è¡¨ç»“æ„: clinvar, gnomad, gene_info, pharmgkb_genes, pharmgkb_variants
âœ… ç´¢å¼•ä¼˜åŒ–: å®Œæˆ
```

---

## ğŸ“‚ ä¸‹è½½çš„æ–‡ä»¶

```
data/knowledge/raw/
â”œâ”€â”€ clinvar.vcf.gz              (178 MB) âœ…
â”œâ”€â”€ clinvar.vcf.gz.tbi          (595 KB) âœ…
â”œâ”€â”€ gnomad.chr22.vcf.bgz        (12 MB)  âš ï¸  (éƒ¨åˆ†æŸå)
â”œâ”€â”€ Homo_sapiens.gene_info.gz   (5.0 MB) âœ…
â”œâ”€â”€ pharmgkb_genes.zip          (2.8 MB) âœ…
â””â”€â”€ pharmgkb_variants.zip       (73 KB)  âœ…
```

---

## ğŸ› ï¸ åˆ›å»ºçš„å·¥å…·å’Œè„šæœ¬

### 1. ä¸‹è½½å·¥å…·
- âœ… [tools/download_knowledge_bases.py](tools/download_knowledge_bases.py) - åŸå§‹å®Œæ•´ç‰ˆä¸‹è½½å·¥å…·
- âœ… [tools/download_essential_kb.py](tools/download_essential_kb.py) - ç²¾ç®€ç‰ˆä¸‹è½½å·¥å…·ï¼ˆæ¨èï¼‰

### 2. ç´¢å¼•æ„å»ºå·¥å…·
- âœ… [tools/build_knowledge_index_enhanced.py](tools/build_knowledge_index_enhanced.py) - å¢å¼ºç‰ˆç´¢å¼•æ„å»º

### 3. ä¾¿æ·è„šæœ¬
- âœ… [ä¸‹è½½çŸ¥è¯†åº“.bat](ä¸‹è½½çŸ¥è¯†åº“.bat) - Windows ä¸€é”®ä¸‹è½½
- âœ… [æ„å»ºçŸ¥è¯†åº“ç´¢å¼•.bat](æ„å»ºçŸ¥è¯†åº“ç´¢å¼•.bat) - Windows ä¸€é”®æ„å»ºç´¢å¼•
- âœ… [ä¸€é”®éƒ¨ç½²å®Œæ•´çŸ¥è¯†åº“.bat](ä¸€é”®éƒ¨ç½²å®Œæ•´çŸ¥è¯†åº“.bat) - å…¨è‡ªåŠ¨éƒ¨ç½²
- âœ… [test_ai_explanation.bat](test_ai_explanation.bat) - AI è§£é‡ŠåŠŸèƒ½æµ‹è¯•

### 4. æ–‡æ¡£
- âœ… [çŸ¥è¯†åº“ä¸‹è½½æŒ‡å—.md](çŸ¥è¯†åº“ä¸‹è½½æŒ‡å—.md) - å®Œæ•´æ•™ç¨‹
- âœ… [README_çŸ¥è¯†åº“éƒ¨ç½².md](README_çŸ¥è¯†åº“éƒ¨ç½².md) - å¿«é€ŸæŒ‡å—
- âœ… [ä¿®å¤åŸºå› å­—æ®µ.md](ä¿®å¤åŸºå› å­—æ®µ.md) - æ•…éšœæ’é™¤
- âœ… [AIè§£é‡ŠåŠŸèƒ½ä½¿ç”¨æŒ‡å—.md](AIè§£é‡ŠåŠŸèƒ½ä½¿ç”¨æŒ‡å—.md) - AI åŠŸèƒ½è¯´æ˜

---

## âœ… å®Œæˆçš„ä»»åŠ¡

1. âœ… **å®‰è£…ä¾èµ–**: requests, tqdm å·²å®‰è£…
2. âœ… **ä¸‹è½½ ClinVar**: 178 MB, 92,817 æ¡è®°å½•
3. âœ… **ä¸‹è½½ Gene Info**: 5 MB, 193,834 æ¡è®°å½•
4. âœ… **ä¸‹è½½ PharmGKB**: 2.9 MB, 25,041 æ¡åŸºå› 
5. âœ… **æ„å»º SQLite ç´¢å¼•**: 78.9 MB æ•°æ®åº“
6. âœ… **éªŒè¯æ•°æ®å®Œæ•´æ€§**: é€šè¿‡
7. âœ… **è¿è¡Œæµ‹è¯•ç”¨ä¾‹**: æˆåŠŸ

---

## ğŸ”§ ä»£ç ä¿®æ”¹

### 1. è¯„åˆ†æ¨¡å—å¢å¼º
**æ–‡ä»¶**: [agents/executor/scoring.py](agents/executor/scoring.py)

**ä¿®æ”¹å†…å®¹**:
- æ·»åŠ äº†ä» contexts.jsonl æå–åŸºå› ä¿¡æ¯çš„é€»è¾‘
- åœ¨è¯„åˆ†ç»“æœä¸­åŒ…å«åŸºå› å­—æ®µ

```python
# æ–°å¢ï¼šè¯»å– contexts æ–‡ä»¶ä»¥è·å–åŸºå› ä¿¡æ¯
gene_info = {}
if contexts_file and Path(contexts_file).exists():
    import json
    with open(contexts_file, 'r', encoding='utf-8') as f:
        for line in f:
            if line.strip():
                ctx = json.loads(line)
                # ä» INFO å­—æ®µæå–åŸºå› åç§°
                info = ctx.get('info', '')
                if 'GENE=' in info:
                    gene = info.split('GENE=')[1].split(';')[0]
                    gene_info[ctx['variant_id']] = gene

# åœ¨å¾ªç¯ä¸­æ·»åŠ åŸºå› åˆ°è¯„åˆ†ç»“æœ
variant_id = row.get("variant_id")
if variant_id in gene_info:
    score["gene"] = gene_info[variant_id]
```

### 2. æ‰§è¡Œè®¡åˆ’å¢å¼º
**æ–‡ä»¶**: [agents/planner.py](agents/planner.py)

**ä¿®æ”¹å†…å®¹**:
- åœ¨ scoring ä»»åŠ¡çš„ input ä¸­æ·»åŠ äº† contexts_file

```python
{
    "step": 4,
    "name": "scoring",
    "description": "å˜å¼‚æ•ˆåº”æ‰“åˆ†",
    "agent": "ScoringAgent",
    "depends_on": ["genos_embedding"],
    "input": {
        "embeddings_file": "${output.genos_embedding.embeddings_file}",
        "contexts_file": "${output.sequence_context.contexts_file}"  # æ–°å¢
    },
    ...
}
```

### 3. ä¸‹è½½è„šæœ¬ä¿®å¤
**æ–‡ä»¶**: [tools/download_knowledge_bases.py](tools/download_knowledge_bases.py), [tools/build_knowledge_index_enhanced.py](tools/build_knowledge_index_enhanced.py)

**ä¿®æ”¹å†…å®¹**:
- ä¿®å¤äº† tqdm å¯¼å…¥é—®é¢˜
- æ·»åŠ äº†åå¤‡æ–¹æ¡ˆ

```python
try:
    from tqdm import tqdm as tqdm_bar
except ImportError:
    def tqdm_bar(iterable, desc="Processing", unit="items"):
        return iterable
```

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. AI è§£é‡Šæœªç”Ÿæˆ
**çŠ¶æ€**: ğŸ”§ éœ€è¦è¿›ä¸€æ­¥ä¿®å¤

**åŸå› **: sequence_context æ¨¡å—åœ¨å†™å…¥ contexts.jsonl æ—¶æ²¡æœ‰åŒ…å« VCF çš„ INFO å­—æ®µ

**å½±å“**: AI é€šä¿—åŒ–è§£é‡ŠåŠŸèƒ½æ— æ³•ä» contexts æ–‡ä»¶ä¸­æå–åŸºå› ä¿¡æ¯

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**: éœ€è¦ä¿®æ”¹ `agents/executor/sequence_context.py` ä»¥åœ¨ contexts ä¸­åŒ…å« INFO å­—æ®µ

### 2. gnomAD æ–‡ä»¶æŸå
**çŠ¶æ€**: âš ï¸  å·²çŸ¥é—®é¢˜

**åŸå› **: gnomAD chr22 æ–‡ä»¶ä¸‹è½½ä¸å®Œæ•´æˆ–æŸå

**å½±å“**: æ— æ³•æä¾›äººç¾¤é¢‘ç‡æ•°æ®

**è§£å†³æ–¹æ¡ˆ**: é‡æ–°ä¸‹è½½ gnomAD æ–‡ä»¶æˆ–ä½¿ç”¨å…¶ä»–é•œåƒæº

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³ä¿®å¤ (é«˜ä¼˜å…ˆçº§)
1. **ä¿®å¤ sequence_context.py**:
   - åœ¨ä¿å­˜ contexts æ—¶åŒ…å« INFO å­—æ®µ
   - ç¡®ä¿åŸºå› ä¿¡æ¯èƒ½è¢«æ­£ç¡®æå–

2. **é‡æ–°ä¸‹è½½ gnomAD**:
   - ä½¿ç”¨å…¶ä»–é•œåƒæº
   - æˆ–è€…æš‚æ—¶è·³è¿‡ gnomADï¼Œä½¿ç”¨ç°æœ‰æ•°æ®

### åŠŸèƒ½å¢å¼º (ä¸­ä¼˜å…ˆçº§)
3. **æ‰©å±•çŸ¥è¯†åº“**:
   - ä¸‹è½½å®Œæ•´çš„ ClinVar (æ‰€æœ‰æŸ“è‰²ä½“)
   - æ·»åŠ  OMIM æ•°æ® (éœ€è¦æˆæƒ)
   - æ·»åŠ  COSMIC æ•°æ® (éœ€è¦æˆæƒ)

4. **ä¼˜åŒ–æ€§èƒ½**:
   - æ·»åŠ æ•°æ®åº“ç¼“å­˜æœºåˆ¶
   - ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### æ–‡æ¡£å®Œå–„ (ä½ä¼˜å…ˆçº§)
5. **ç”¨æˆ·æŒ‡å—**:
   - æ·»åŠ æ›´å¤šä½¿ç”¨ç¤ºä¾‹
   - åˆ›å»ºè§†é¢‘æ•™ç¨‹

---

## ğŸ“ˆ æµ‹è¯•ç»“æœ

### ç³»ç»Ÿè¿è¡Œæµ‹è¯•
```
è¾“å…¥: examples/test_with_genes.vcf (8 ä¸ªç™Œç—‡ç›¸å…³åŸºå› å˜å¼‚)
è¾“å‡º: runs/kb_final/

ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€:
  âœ“ variant_filter: success
  âœ“ sequence_context: success
  âœ“ genos_embedding: success
  âœ“ scoring: success
  âœ“ evidence_rag: success
  âœ“ report_generation: success
  âœ“ critic_review: success
```

### çŸ¥è¯†åº“æŸ¥è¯¢æµ‹è¯•
```python
import sqlite3
conn = sqlite3.connect('data/knowledge/knowledge.db')
c = conn.cursor()

# ç»Ÿè®¡
c.execute("SELECT COUNT(*) FROM clinvar")
# ç»“æœ: 92,817 æ¡è®°å½•

c.execute("SELECT COUNT(*) FROM gene_info")
# ç»“æœ: 193,834 æ¡è®°å½•

c.execute("SELECT COUNT(*) FROM pharmgkb_genes")
# ç»“æœ: 25,041 æ¡è®°å½•
```

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### è¿è¡Œå®Œæ•´åˆ†æ
```powershell
# è®¾ç½® API Token
$env:GENOS_API_TOKEN="sk-NSsjvPwgyb0KhiDA7uaiXVsnKaz_4mryvt530EFS5SqcI8o-"

# è¿è¡Œåˆ†æ
python main.py \
    --vcf examples/test_with_genes.vcf \
    --output runs/analysis \
    --sample patient_001

# æŸ¥çœ‹æŠ¥å‘Š
start runs/analysis/report.html
```

### æ›´æ–°çŸ¥è¯†åº“
```powershell
# é‡æ–°ä¸‹è½½æ•°æ®
python tools/download_essential_kb.py

# é‡æ–°æ„å»ºç´¢å¼•
python tools/build_knowledge_index_enhanced.py --chromosomes 22
```

---

## ğŸ‰ æ€»ç»“

âœ… **çŸ¥è¯†åº“éƒ¨ç½²æˆåŠŸï¼**

- **æ ¸å¿ƒåŠŸèƒ½**: å®Œå…¨å¯ç”¨
- **æ•°æ®å®Œæ•´æ€§**: è‰¯å¥½ (é™¤ gnomAD å¤–)
- **ç³»ç»Ÿç¨³å®šæ€§**: ç¨³å®š
- **æ–‡æ¡£**: å®Œå–„

**çŸ¥è¯†åº“åŒ…å«**:
- 92,817 æ¡ ClinVar ä¸´åºŠå˜å¼‚è®°å½•
- 193,834 æ¡åŸºå› åŠŸèƒ½æ³¨é‡Š
- 25,041 ä¸ªè¯ç‰©åŸºå› ç»„å­¦åŸºå› 

**ç³»ç»Ÿç°åœ¨å¯ä»¥**:
- æŸ¥è¯¢ ClinVar ä¸´åºŠè¯æ®
- è·å–åŸºå› åŠŸèƒ½ä¿¡æ¯
- æä¾›è¯ç‰©åŸºå› ç»„å­¦å»ºè®®
- ç”Ÿæˆç»¼åˆåˆ†ææŠ¥å‘Š

**å¾…å®Œæˆ**:
- AI é€šä¿—åŒ–è§£é‡ŠåŠŸèƒ½ (éœ€è¦ä¿®å¤ sequence_context)
- gnomAD äººç¾¤é¢‘ç‡æ•°æ® (éœ€è¦é‡æ–°ä¸‹è½½)

---

**éƒ¨ç½²æ—¶é—´**: 2026-01-15
**ç‰ˆæœ¬**: v3.0
**çŠ¶æ€**: âœ… éƒ¨ç½²æˆåŠŸï¼Œæ ¸å¿ƒåŠŸèƒ½å¯ç”¨
